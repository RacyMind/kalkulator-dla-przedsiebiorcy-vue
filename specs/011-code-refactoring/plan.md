# Implementation Plan: Refaktoryzacja kodu (Milestone 2)

**Branch**: `011-code-refactoring` | **Date**: 2026-02-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-code-refactoring/spec.md`

## Summary

Refactoring the entire codebase: migrate 5 JS files to TypeScript, migrate 30 Vue components to `<script setup lang="ts">`, replace dual constants system with a dedicated Pinia store, extract 3 code duplications into shared modules, consolidate `src/use/` into `src/composables/`, and create a full Design Tokens system (`_design-tokens.scss`) with new color palette (WCAG AA compliant, light/dark variants). No calculation logic changes — all 410+ tests must pass after each step.

## Technical Context

**Language/Version**: TypeScript 5.9.3 / Vue 3.5.27
**Framework**: Quasar 2.18.6 (UI components)
**State Management**: Pinia 2.3.1
**Testing**: Vitest 4.0.18
**Charts**: Chart.js 4.5.1 + vue-chartjs 5.3.3
**Platform**: PWA + Capacitor (Android)
**Project Type**: SPA (Single-page application)
**UI Language**: Polish
**Key Dependencies**:
- `BasicCalculator` — base class for all calculators
- `validationRules` — form validation rules
- `useConstants()` — composable providing year-dependent constants (to be replaced by Pinia store)
- `src/logic/constants.ts` — static data + PARAMS per year (to be replaced by Pinia store)
- `helpers.ts` — round, scrollToElement, sumMonthlyResults, applyMixins, formatNumber

**Components requiring migration to `<script setup>`** (30 files):
- `src/App.vue`
- `src/pages/Error404.vue`
- `src/components/partials/` — Menu.vue, Item.vue, ChooseYear.vue, DatePopup.vue, LineChart.vue, ListRow.vue, SalarySummaryTable.vue, SupportProject.vue, YearlySummaryTable.vue
- `src/components/cashRegisterLimit/` — Form.vue, Summary.vue
- `src/components/changeLogs/` — ChangeLog.vue
- `src/components/contact/` — Form.vue
- `src/components/inflation/` — InflationStatistics.vue, PurchasingPowerOfMoneyStatistics.vue
- `src/components/interest/` — Form.vue, Statistics.vue, Summary.vue
- `src/components/investment/` — Form.vue, Summary.vue
- `src/components/invoice/` — Form.vue, Statistics.vue, Summary.vue
- `src/components/terms/` — PFRONSummary.vue, USSummary.vue, ZUSSummary.vue
- `src/components/vatLimit/` — Form.vue, Summary.vue

**Files requiring JS→TS migration** (5 files):
- `src/logic/employeeContributions.js`
- `src/logic/employerContributions.js`
- `src/logic/jointAccounting.js`
- `src/use/currencyFormat.js`
- `src/use/deepEqual.js`

**Code duplications to extract**:
- `findGrossAmountUsingNetAmount` — exists in 3 modules (contractWork, contractOfMandate, contractOfEmployment)
- Tax threshold notification — duplicated in contractOfEmployment and selfEmployment
- `scrollToElement` + `ref(summary)` — repeated in 21 modules

**`applyMixins` usage**: Used by 4 files (FlatTax.ts, LumpSumTax.ts, TaxScale.ts, EmployerZusContribution.ts, EntrepreneurZusContribution.ts) — still actively used, cannot remove

**Design Tokens sources to consolidate**:
- `src/css/quasar.variables.scss` — $primary: #d12526, $secondary: #26A69A, $accent: #9C27B0, etc.
- `src/logic/constants.ts → COLORS` — 14 module/chart colors
- `src/css/components/_*.scss` (7 files) — per-module brand colors (e.g., _work.scss: #B45309)

## Constitution Check

*Constitution is an unfilled template — no project-specific gates defined. Proceeding with standard quality gates.*

**Standard gates applied**:
- All 410+ existing tests must pass after each refactoring step
- No calculation logic changes permitted
- Code follows existing project patterns (reference: `src/components/contractWork/`)

## Project Structure

### Documentation (this feature)

```text
specs/011-code-refactoring/
├── plan.md              # This file
├── research.md          # Research and analysis
├── data-model.md        # Data model (Pinia store interfaces)
├── quickstart.md        # Quick start guide
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code Changes

```text
src/
├── stores/
│   └── constantsStore.ts        # NEW: Dedicated Pinia store replacing both constants files
├── composables/
│   ├── useChartColors.ts        # NEW: Reads CSS custom properties for chart colors
│   ├── useScrollToResults.ts    # NEW: Extracted scroll-to-results pattern
│   ├── useTaxThresholdNotification.ts  # NEW: Extracted tax threshold logic
│   ├── currencyFormat.ts        # MOVED from src/use/ + typed
│   ├── deepEqual.ts             # MOVED from src/use/ + typed with generics
│   └── formValidation.ts        # EXISTS
├── logic/
│   ├── findGrossAmountUsingNetAmount.ts  # NEW: Shared, generic version
│   ├── employeeContributions.ts  # MIGRATED from .js
│   ├── employerContributions.ts  # MIGRATED from .js
│   ├── jointAccounting.ts        # MIGRATED from .js (setYear → store param)
│   └── helpers.ts                # CLEANED: sumMonthlyResults moved closer to modules
├── css/
│   ├── _design-tokens.scss       # NEW: Full color palette (light + dark)
│   ├── quasar.variables.scss     # UPDATED: mapped to new palette
│   └── components/_*.scss        # UPDATED: hex → var(--module-brand-*)
└── components/
    └── [30 .vue files]           # MIGRATED to <script setup lang="ts">
```

## Execution Phases

### Phase 1: JS→TS Migration (Low risk, no architecture changes)

**Order**: Leaf files first (no internal dependencies), then files with dependencies.

1. Migrate `src/use/currencyFormat.js` → `src/composables/currencyFormat.ts`
2. Migrate `src/use/deepEqual.js` → `src/composables/deepEqual.ts` (TypeScript generics)
3. Migrate `src/logic/employeeContributions.js` → `.ts`
4. Migrate `src/logic/employerContributions.js` → `.ts`
5. Migrate `src/logic/jointAccounting.js` → `.ts` (replace `setYear()` with parameter)
6. Update all imports referencing old paths
7. Delete `src/use/currencyFormat.js`, `src/use/deepEqual.js`
8. Run `npx vitest run` — all tests must pass

### Phase 2: Vue Component Migration (Medium risk, UI changes)

**Order**: Shared partials first, then module-specific components.

1. Migrate `src/components/partials/` components (9 files): Menu.vue, Item.vue, ChooseYear.vue, DatePopup.vue, LineChart.vue, ListRow.vue, SalarySummaryTable.vue, SupportProject.vue, YearlySummaryTable.vue
2. Migrate `src/App.vue` and `src/pages/Error404.vue`
3. Migrate module components batch 1 — cashRegisterLimit, changeLogs, contact, vatLimit (7 files)
4. Migrate module components batch 2 — inflation, interest, investment, invoice (10 files)
5. Migrate module components batch 3 — terms (3 files)
6. Run `npx vitest run` after each batch — all tests must pass
7. Verify: `grep -r "defineComponent" src/ --include="*.vue"` returns 0 results

### Phase 3: Constants System Unification (High risk, architecture change)

**Strategy**: Create new Pinia store first, migrate consumers incrementally, delete old files last.

1. Design typed interfaces for the new `constantsStore` (ZUS, IncomeTax, WageStats, AppConfig)
2. Create `src/stores/constantsStore.ts` as Pinia store with getters for year-dependent data
3. Migrate PARAMS data from `src/logic/constants.ts` into the new store
4. Migrate computed logic from `src/composables/constants.ts` into the new store
5. Update consumers one module at a time (replace `useConstants()` → `useConstantsStore()`)
6. Update `helpers.ts` → `getDefaultYear()` to use new store
7. Run `npx vitest run` after each module migration
8. Delete `src/logic/constants.ts` and `src/composables/constants.ts`
9. Run full test suite — all tests must pass

### Phase 4: Code Deduplication (Medium risk)

1. Extract `src/logic/findGrossAmountUsingNetAmount.ts` — generic version accepting Calculator as parameter
2. Update contractWork, contractOfMandate, contractOfEmployment to import from shared file
3. Delete module-specific `findGrossAmountUsingNetAmount.ts` files (3 files)
4. Extract `src/composables/useTaxThresholdNotification.ts` from contractOfEmployment + selfEmployment
5. Extract `src/composables/useScrollToResults.ts` from the 21 modules using scrollToElement pattern
6. Move `sumMonthlyResults` from `helpers.ts` to a module-local helper near ContractOfEmployment/ContractOfMandate
7. Run `npx vitest run` — all tests must pass

### Phase 5: Code Structure Cleanup (Low risk)

1. Move remaining composables from `src/use/` to `src/composables/`
2. Update all imports referencing `src/use/` paths
3. Delete `src/use/` directory (or leave empty `.gitkeep` if needed)
4. Clean `helpers.ts` — verify `applyMixins` is still used (yes: 4 tax/zus files), keep it
5. Run `npx vitest run` — all tests must pass

### Phase 6: Design Tokens (Medium risk, visual changes)

**Strategy**: Define tokens first, then migrate sources one by one, verify visually.

1. Research and design new color palette (primary, secondary, accent, module brands, chart colors, surfaces, semantic) — all WCAG AA compliant
2. Create `src/css/_design-tokens.scss` with CSS custom properties:
   - `:root` — light mode tokens
   - `.body--dark` — dark mode tokens
   - Module classes (`.c-work`, `.c-business`, `.c-taxes`, `.c-currencies`, `.c-percentage`, `.c-informator`)
3. Update `src/css/quasar.variables.scss` — map `$primary`, `$secondary`, `$accent` to new values
4. Update 7 `src/css/components/_*.scss` files — replace hardcoded hex with `var(--module-brand-*)`
5. Create `src/composables/useChartColors.ts` — reads CSS custom properties via `getComputedStyle`
6. Remove `COLORS` object from constants store (replaced by `useChartColors`)
7. Update all chart composables (`usePieChart.ts`, `useBarChart.ts`, `useLineChart.ts`) to use `useChartColors()`
8. Run `npx vitest run` — all tests must pass
9. Visual verification in browser — colors consistent in light mode

## Risk Assessment

| Phase | Risk | Mitigation |
|-------|------|------------|
| 1. JS→TS | Low | Pure type additions, no logic changes |
| 2. Vue Migration | Medium | Run tests after each batch, visual spot-check |
| 3. Constants Store | **High** | Incremental migration, one module at a time, tests after each |
| 4. Deduplication | Medium | Generic function must handle all existing Calculator types |
| 5. Cleanup | Low | Only file moves and import updates |
| 6. Design Tokens | Medium | New palette needs WCAG AA verification, visual QA |

## Pre-Implementation Checklist

- [ ] All 410+ existing tests pass before starting
- [ ] Branch `011-code-refactoring` is up to date with main
- [ ] `npx vitest run` baseline established
- [ ] Reference pattern reviewed: `src/components/contractWork/`
- [ ] WCAG AA contrast checker tool available (WebAIM or axe-core)
- [ ] Changelog updated in `src/components/changeLogs/logs.ts` after completion
